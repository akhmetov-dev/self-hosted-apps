## Код ответа при срабатывании ограничений
limit_req_status 429;
limit_conn_status 429;

## Ограничиваем только выбранные конечные точки (endpoint)
## Логика: для большинства URL ключ пустой (""), и лимит не применяется.
## Для чувствительных URL ключ = IP клиента ($binary_remote_addr) и лимит включается.

## Ключ для rate limit (лимит по частоте запросов)
map $uri $perip_req_key {
    default "";
    ## Nextcloud: логин
    ~^/(index\.php/)?login$ $binary_remote_addr;
    ## Vaultwarden: выдача токена (часто цель брутфорса)
    ~^/identity/connect/token$ $binary_remote_addr;
}

## Зона для rate limit по $perip_req_key
limit_req_zone $perip_req_key zone=perip_req:10m rate=10r/s;

## Ключ для limit_conn (лимит на количество одновременных соединений)
map $uri $perip_conn_key {
    default "";
    ## Nextcloud: логин
    ~^/(index\.php/)?login$ $binary_remote_addr;
    ## Vaultwarden: выдача токена
    ~^/identity/connect/token$ $binary_remote_addr;
}

## Зона для количества одновременных соединений по $perip_conn_key
limit_conn_zone $perip_conn_key zone=perip_conn:10m;

## Применение лимитов
## burst=20 позволяет короткий всплеск запросов без задержки (nodelay)
limit_req zone=perip_req burst=20 nodelay;
## 10 одновременных соединений на IP для выбранных endpoint
limit_conn perip_conn 10;
